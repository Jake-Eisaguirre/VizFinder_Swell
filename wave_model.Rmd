---
title: "VizFinder_Swell"
author: "Jake Eisaguirre"
date: "10/24/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(raster)
library(sf)
library(here)
library(lubridate)
library(tidyverse)
library(magick)
library(colorRamps)


```

# Read in data
```{r}
date <- as.Date(Sys.time())
  

date <- as.Date(date)  %>% 
   paste0("T12:00:00Z")

fut_date <- as.Date(date) +5 

fut_date <- as.Date(fut_date) %>% 
   paste0("T12:00:00Z") 


#height
url_Hs <- paste0("http://thredds.cdip.ucsd.edu/thredds/ncss/cdip/model/MOP_grids/CA_0.01_forecast.nc?var=waveHs&north=34.75&west=-121.4&east=-117.06&south=32.36&disableLLSubset=on&disableProjSubset=on&horizStride=1&time_start=", date, "&time_end=", fut_date, "&timeStride=1&addLatLon=true&accept=netcdf")


download.file(url_Hs, here('data',"wave_data_Hs.nc"))

Hs <- here('data',"wave_data_Hs.nc")

wave_Hs <-brick(Hs)


#period
url_Ta <- paste0("http://thredds.cdip.ucsd.edu/thredds/ncss/cdip/model/MOP_grids/CA_0.01_forecast.nc?var=waveTa&north=34.75&west=-121.4&east=-117.06&south=32.36&disableLLSubset=on&disableProjSubset=on&horizStride=1&time_start=", date, "&time_end=", fut_date, "&timeStride=1&addLatLon=true&accept=netcdf")


Ta <- download.file(url_Ta, here('data',"wave_data_Ta.nc"))

Ta <- here('data',"wave_data_Ta.nc")

wave_Ta <-brick(Ta)

```


# Shape Files
```{r}
islands <- read_sf(here('data', "shape",'island_shape', "channel_islands.shp")) %>% 
  mutate(geometry = st_transform(geometry, crs = 4326))

ca <- read_sf(here('data', "shape","s_11au16", "s_11au16.shp")) %>% 
  mutate(geometry = st_transform(geometry, crs = 4326)) %>% 
  filter(NAME == "California") %>% 
  select(geometry)

merged_shapes <- bind_rows(ca, islands)
```

# crop and re-sample swell
```{r}

hs_res <- c(0.005, 0.005) 

new_ras_hs <- raster(xmn = -121.4,
                      xmx = -117.06,
                      ymn = 32.36,
                      ymx = 34.75,
                      res = hs_res)

re_samp_hs <- resample(wave_Hs, new_ras_hs, method = "bilinear")

cropped_hs <- mask(re_samp_hs, merged_shapes, inverse = T)

final_ras_hs <- projectRaster(cropped_hs, crs = 4326)

rm(new_ras_hs, wave_Hs, re_samp_hs, cropped_hs)
gc()
```


#clean swell data
```{r}

Hs_data <- as.data.frame(rasterToPoints(final_ras_hs)) %>% 
  pivot_longer(!c(x,y), names_to = "date", values_to = "height")

clean_data <- Hs_data %>% 
  mutate(date = gsub("X", "", date),
         date = as.numeric(date),
         date = as_datetime(date),
         height = 3.28 * height)
rm(Hs_data, final_ras_hs)
gc()
```
# crop and re-sample period
```{r}
# ta_res <- c(0.005, 0.005) 
# 
# new_ras_ta <- raster(xmn = -121.4,
#                       xmx = -117.06,
#                       ymn = 32.36,
#                       ymx = 34.75,
#                       res = ta_res)
# 
# re_samp_ta <- resample(wave_Ta, new_ras_ta, method = "bilinear")
# 
# cropped_ta <- mask(re_samp_ta, merged_shapes, inverse = T)
# 
# final_ras_ta <- projectRaster(cropped_ta, crs = 4326)
# 
# rm(new_ras_ta, wave_Ta, re_samp_ta, cropped_ta, merged_shapes, islands, ca)
# gc()
```

# period data
```{r}
Ta_data <- as.data.frame(rasterToPoints(wave_Ta)) %>%
  pivot_longer(!c(x,y), names_to = "date", values_to = "period") %>%
  mutate(date = gsub("X", "", date),
         date = as.numeric(date),
         date = as_datetime(date)) 


#ub_1 <- subset(Ta_data, x %in% ta_loc$x)

# 
# period_stamp <- Ta_data %>% 
#     filter(x %in% sort(unique(x))[c(T, F, F, F, F, F, F, F, 
#                                     F, F, F, F, F, F, F, F, F,
#                                     F, F, F, F, F, F, F, F, F,
#                                     F, F, F, F, F, F, F, F, F,
#                                     F, F, F, F, F, F, F, F, F)], 
#            y %in% sort(unique(y))[c(T, F, F, F, F, F, F, F, 
#                                     F, F, F, F, F, F, F, F, F,
#                                     F, F, F, F, F, F, F, F, F,
#                                     F, F, F, F, F, F, F, F, F,
#                                     F, F, F, F, F, F, F, F, F)]) %>% 
#   mutate(period = round(period, 1))

# rm(final_ras_ta)
# gc()
```


# pal
```{r}
swell_pal <- colorRampPalette(c("lightskyblue2", "deepskyblue4", "seagreen3", "khaki2", "orangered","darkred"))
  
# colorRampPalette(c("deepskyblue4", "lightskyblue3", "mediumseagreen", "khaki2", "orangered",
#                           "darkred"))

#period_pal <- colorRampPalette(c("darkred","orangered", "khaki2", "mediumseagreen", "lightskyblue3", "deepskyblue4"))



limits <- c(0, 16)
```

#loop to create each plot for swell
```{r}
swell.list = lapply(sort(unique(clean_data$date)), function(i) {
  ggplot(data = clean_data[clean_data$date==i,], aes(y=y, x=x)) +
  geom_raster(aes(fill = height), interpolate = T) +
  facet_wrap(~as.factor(date)) +
  scale_fill_gradientn(colours = swell_pal(10), limits = limits) +
  theme_classic() +
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),legend.position="none",
          panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank(),
        plot.margin=unit(c(0,0,0,0), "null"),
        strip.background = element_blank(),
        strip.text.x = element_blank()) +
  coord_sf(xlim = c(-121.4, -117.06), ylim = c(32.36, 34.75), expand = F)
})


```

# loop to create each plot for period 
```{r}
# period.list = lapply(sort(unique(Ta_data$date)), function(i) {
#   ggplot(data = Ta_data[Ta_data$date==i,], aes(y=y, x=x)) +
#   geom_raster(aes(fill = period), interpolate = T) +
#   facet_wrap(~as.factor(date)) +
#   scale_fill_gradientn(colours = period_pal(10), limits = limits) +
#   #geom_text(data = period_stamp, aes(label = period), size = 2) +
#   theme_classic() +
#   theme(axis.line=element_blank(),axis.text.x=element_blank(),
#           axis.text.y=element_blank(),axis.ticks=element_blank(),
#           axis.title.x=element_blank(),
#           axis.title.y=element_blank(),legend.position="none",
#           panel.background=element_blank(),
#         panel.border=element_blank(),
#         panel.grid.major=element_blank(),
#         panel.grid.minor=element_blank(),
#         plot.background=element_blank(),
#         plot.margin=unit(c(0,0,0,0), "null"),
#         strip.background = element_blank(),
#         strip.text.x = element_blank()) +
#   coord_sf(xlim = c(-121.4, -117.06), ylim = c(32.36, 34.75), expand = F)
# })
#   
# period.list[[16]]
```


# ggsave loop for swell  
```{r}
#variable to adjust saved sst resolution
hs_dpi <- c(215)

unlink("pngs/swell/old/*")

for(i in 1:length(swell.list)){
  
  ggsave(paste0(here('pngs', 'swell', 'old'), "/", clean_data$date[i], '.png'), dpi = hs_dpi, 
         bg = "transparent", plot = swell.list[[i]])
}


```

# Magick loop for swell
```{r}

unlink("pngs/swell/site_ready/*")

for(i in 1:length(swell.list)){
  hs <- image_read(paste0(here('pngs', 'swell', 'old'), "/", clean_data$date[i], '.png'))
  hs <- image_trim(hs)
  hs <- image_transparent(hs, "white")
  image_write(hs, paste0(here('pngs', 'swell', 'site_ready'), "/", clean_data$date[i], '.png'))
}

```


# ggsave loop for period 
```{r}
#variable to adjust saved sst resolution
# ta_dpi <- c(215)
# 
# unlink("pngs/period/old/*")
# 
# for(i in 1:length(period.list)){
#   
#   ggsave(paste0(here('pngs', 'period', 'old'), "/", Ta_data$date[i], '.png'), dpi = ta_dpi, 
#          bg = "transparent", plot = period.list[[i]])
# }


```

# Magick loop for period
```{r}

# unlink("pngs/period/site_ready/*")
# 
# for(i in 1:length(period.list)){
#   ta <- image_read(paste0(here('pngs', 'period', 'old'), "/", Ta_data$date[i], '.png'))
#   ta <- image_trim(ta)
#   ta <- image_transparent(ta, "white")
#   image_write(ta, paste0(here('pngs', 'period', 'site_ready'), "/", Ta_data$date[i], '.png'))
# }

```
